name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: |
          npm run prebuild
          npm run build

      - name: Verify build files
        run: |
          echo "Checking dist directory..."
          ls -la dist/
          echo "Checking main files..."
          ls -la ultra-card.js* hacs.json README.md license

      - name: Create Release Archive
        run: |
          mkdir -p release
          cp ultra-card.js release/
          cp ultra-card.js.LICENSE.txt release/
          cp hacs.json release/
          cp README.md release/
          cp license release/
          cd release
          zip -r ../ultra-card-${{ github.ref_name }}.zip .
          cd ..
          echo "Archive contents:"
          unzip -l ultra-card-${{ github.ref_name }}.zip

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"

          # Extract release notes from RELEASE_NOTES.md based on version
          if [[ "$VERSION" == *"1.2.0-beta1"* ]]; then
            cat > release_notes.md << 'EOF'
          ## New Features

          - **New Dropdown Module**: Interactive dropdown selector with Home Assistant actions
            - Support for More Info, Toggle, Navigate, URL, Perform Action, and Assist actions
            - Entity picker integration for More Info and Toggle actions
            - "Keep Selection State" option for scene selectors
            - Icon support with custom colors or entity state colors
            - Drag & drop option reordering
            - Full Global Design Tab compatibility

          ## Improvements

          - Enhanced action system integration
          - Improved editor event handling
          - Better z-index management for dropdown layering
          EOF
          else
            # Default release notes for other versions
            cat > release_notes.md << 'EOF'
          ## üîó Link Updates

          - **Updated Support Links**: Updated PayPal tip link to new payment URL
          - **Updated Community Links**: Updated Discord server invitation link

          ## üìù Changes Made

          - Updated PayPal tip link in README.md and About tab
          - Updated Discord invitation link in README.md and About tab

          These updates ensure users can properly access our support and community channels.
          EOF
          fi

          # Set the release notes as output
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: What's New in ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: false
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            ultra-card-${{ github.ref_name }}.zip
            ultra-card.js

      - name: Announce to Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          BOT_NAME: 'UpdateBot'
          AVATAR_URL: 'https://raw.githubusercontent.com/${{ github.repository }}/main/Ultra.jpg'
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Missing DISCORD_WEBHOOK secret - skipping Discord notification"
            exit 0
          fi

          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ github.ref_name }}"
          URL="https://github.com/${{ github.repository }}/releases/tag/$TAG"
          REPO="${{ github.repository }}"
          REPO_NAME="${REPO#*/}"

          # Use the same release notes we generated
          DESC="${{ steps.release_notes.outputs.RELEASE_NOTES }}"

          # Truncate description to fit Discord embed limits
          DESC=$(echo "$DESC" | head -c 1900)

          COLOR=3447003    # Blue for stable release
          RELEASE_TYPE="Release"

          # Build JSON payload for Discord
          PAYLOAD=$(jq -n \
            --arg username "$BOT_NAME" \
            --arg avatar_url "$AVATAR_URL" \
            --arg title "What's New in $VERSION" \
            --arg url "$URL" \
            --arg desc "$DESC" \
            --arg repo "$REPO_NAME" \
            --arg tag "$TAG" \
            --arg rtype "$RELEASE_TYPE" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg footer "Ultra-Card ‚Ä¢ $RELEASE_TYPE ‚Ä¢ $TAG" \
            --arg author "WJDDesigns/Ultra-Card" \
            --argjson color $COLOR \
            '{
              "username": $username,
              "avatar_url": $avatar_url,
              "embeds": [
                {
                  "title": $title,
                  "url": $url,
                  "description": $desc,
                  "color": $color,
                  "timestamp": $ts,
                  "author": { "name": $author },
                  "footer": { "text": $footer },
                  "fields": [
                    { "name": "Tag", "value": $tag, "inline": true },
                    { "name": "Repo", "value": $repo, "inline": true }
                  ]
                }
              ]
            }')

          echo "Sending Discord notification..."
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}\n" -X POST -H "Content-Type: application/json" \
                          -d "$PAYLOAD" "$DISCORD_WEBHOOK")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

          echo "HTTP Response Code: $HTTP_CODE"
          if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Successfully sent Discord notification"
          else
            echo "‚ùå Failed to send Discord notification (HTTP $HTTP_CODE)"
            echo "Response: $RESPONSE_BODY"
          fi
